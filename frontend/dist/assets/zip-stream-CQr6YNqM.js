class b{constructor(){this.table=(()=>{let n,t,u;const d=[];for(n=0;n<256;n++){for(u=n,t=0;t<8;t++)u=u&1?u>>>1^3988292384:u>>>1;d[n]=u}return d})(),this.crc=-1}append(n){let t=this.crc|0;const u=this.table;for(let d=0,w=n.length|0;d<w;d++)t=t>>>8^u[(t^n[d])&255];this.crc=t}get(){return~this.crc}}const g=o=>{const n=new Uint8Array(o);return{array:n,view:new DataView(n.buffer)}},q=o=>o.reader.read().then(n=>{if(n.done)return o.writeFooter();const t=n.value;o.crc.append(t),o.uncompressedLength+=t.length,o.compressedLength+=t.length,o.ctrl.enqueue(t)});function x(o){const n=Object.create(null),t=[],u=new TextEncoder;let d=0,w=0,h,a,m;function p(){w++,a=n[t[w]],a?v():m&&y()}const U={enqueue(c){if(m)throw new TypeError("Cannot enqueue a chunk into a readable stream that is closed or has been requested to be closed");let r=c.name.trim();const i=new Date(typeof c.lastModified>"u"?Date.now():c.lastModified);if(c.directory&&!r.endsWith("/")&&(r+="/"),n[r])throw new Error("File already exists.");const s=u.encode(r);t.push(r);const e=n[r]={level:0,ctrl:h,directory:!!c.directory,nameBuf:s,comment:u.encode(c.comment||""),compressedLength:0,uncompressedLength:0,writeHeader(){const l=g(26),f=g(30+s.length);e.offset=d,e.header=l,e.level!==0&&!e.directory&&l.view.setUint16(4,2048),l.view.setUint32(0,335546376),l.view.setUint16(6,(i.getHours()<<6|i.getMinutes())<<5|i.getSeconds()/2,!0),l.view.setUint16(8,(i.getFullYear()-1980<<4|i.getMonth()+1)<<5|i.getDate(),!0),l.view.setUint16(22,s.length,!0),f.view.setUint32(0,1347093252),f.array.set(l.array,4),f.array.set(s,30),d+=f.array.length,h.enqueue(f.array)},writeFooter(){const l=g(16);l.view.setUint32(0,1347094280),e.crc&&(e.header.view.setUint32(10,e.crc.get(),!0),e.header.view.setUint32(14,e.compressedLength,!0),e.header.view.setUint32(18,e.uncompressedLength,!0),l.view.setUint32(4,e.crc.get(),!0),l.view.setUint32(8,e.compressedLength,!0),l.view.setUint32(12,e.uncompressedLength,!0)),h.enqueue(l.array),d+=e.compressedLength+16,p()},fileLike:c};a||(a=e,v())},close(){if(m)throw new TypeError("Cannot close a readable stream that has already been requested to be closed");a||y(),m=!0}};function y(){let c=0,r=0,i,s;for(i=0;i<t.length;i++)s=n[t[i]],c+=46+s.nameBuf.length+s.comment.length;const e=g(c+22);for(i=0;i<t.length;i++)s=n[t[i]],e.view.setUint32(r,1347092738),e.view.setUint16(r+4,5120),e.array.set(s.header.array,r+6),e.view.setUint16(r+32,s.comment.length,!0),s.directory&&e.view.setUint8(r+38,16),e.view.setUint32(r+42,s.offset,!0),e.array.set(s.nameBuf,r+46),e.array.set(s.comment,r+46+s.nameBuf.length),r+=46+s.nameBuf.length+s.comment.length;e.view.setUint32(r,1347093766),e.view.setUint16(r+8,t.length,!0),e.view.setUint16(r+10,t.length,!0),e.view.setUint32(r+12,c,!0),e.view.setUint32(r+16,d,!0),h.enqueue(e.array),h.close()}function v(){if(a){if(a.directory)return a.writeFooter(a.writeHeader());if(a.reader)return q(a);a.fileLike.stream?(a.crc=new b,a.reader=a.fileLike.stream().getReader(),a.writeHeader()):p()}}return new ReadableStream({start:c=>{h=c,o.start&&Promise.resolve(o.start(U))},pull(){return v()||o.pull&&Promise.resolve(o.pull(U))}})}export{x as c};
